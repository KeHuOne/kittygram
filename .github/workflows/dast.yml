name: üß™ DAST ZAP Scan

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  zap-scan:
    name: üì° OWASP ZAP Full Scan
    runs-on: ubuntu-latest

    outputs:
      warn: ${{ steps.zap_summary.outputs.warn }}
      fail: ${{ steps.zap_summary.outputs.fail }}
      pass: ${{ steps.zap_summary.outputs.pass }}

    steps:
      - name: üìÅ Create output files
        run: |
          touch report_html.html report_json.json report_md.md
          chmod a+w report_html.html report_json.json report_md.md

      - name: üì° Run ZAP Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://185.121.13.20:9000'
          fail_action: false
          cmd_options: '-a -j'
          allow_issue_writing: false

      - name: üíæ Save ZAP reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: |
            report_html.html
            report_json.json
            report_md.md

      - name: üîß Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: üìä Extract ZAP scan results
        id: zap_summary
        run: |
          WARN=$(jq '.site[0].alerts[] | select(.riskcode=="2")' report_json.json | wc -l)
          FAIL=$(jq '.site[0].alerts[] | select(.riskcode=="3")' report_json.json | wc -l)
          PASS=$(jq '.site[0].alerts' report_json.json | jq length)
          echo "warn=$WARN" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "pass=$PASS" >> $GITHUB_OUTPUT

  send-message:
    name: üì£ Telegram Notification
    runs-on: ubuntu-latest
    needs: zap-scan

    steps:
      - name: üì¨ Send message to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_KITTY_TO }}
          token: ${{ secrets.TELEGRAM_KITTY_TOKEN }}
          message: |
            üß™ ZAP DAST –∑–∞–≤–µ—Ä—à—ë–Ω

            ‚ö† Warnings: ${{ needs.zap-scan.outputs.warn }}
            üö´ Fails: ${{ needs.zap-scan.outputs.fail }}
            ‚úÖ –í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: ${{ needs.zap-scan.outputs.pass }}

            ${{ fromJSON('["‚ùó–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏!", "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ—Ç."]')[needs.zap-scan.outputs.fail == '0'] }}

            üìé –û—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –≤ GitHub Actions.